<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#76A665">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>SlothDrop P2P Fix</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3750/3750019.png">
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@500;600;700&display=swap');
        
        :root {
            --primary: #76A665;
            --primary-dark: #5e8550;
            --bg: #F2F7F2;
            --card: #FFFFFF;
            --text: #2C3E50;
            --grey: #95A5A6;
            --bubble-self: #76A665;
            --bubble-friend: #FFFFFF;
            --error: #E74C3C;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Quicksand', sans-serif; background: var(--bg); color: var(--text);
            margin: 0; display: flex; flex-direction: column; align-items: center; 
            height: 100vh; overflow: hidden;
        }

        /* È°∂ÈÉ®Ê†è */
        .header {
            width: 100%; height: 60px; background: rgba(255,255,255,0.95);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 1px 5px rgba(0,0,0,0.05); z-index: 10; flex-shrink: 0;
            backdrop-filter: blur(5px);
        }
        .header h1 { 
            font-size: 1.3rem; margin: 0; display: flex; align-items: center; gap: 10px; color: var(--primary);
        }

        /* ‰∏ªÊªöÂä®Âå∫ */
        .main-scroll {
            flex: 1; width: 100%; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; align-items: center; gap: 20px;
            padding-bottom: 100px;
        }

        /* Âç°ÁâáÈÄöÁî® */
        .card {
            width: 100%; max-width: 450px; background: var(--card);
            border-radius: 20px; padding: 20px;
            box-shadow: 0 5px 15px rgba(118, 166, 101, 0.1);
            transition: transform 0.2s;
        }
        
        .card-title {
            font-size: 0.75rem; color: var(--grey); font-weight: 700; 
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; display: block;
        }

        /* ID Âå∫Âüü */
        .id-row { display: flex; align-items: center; gap: 15px; }
        .qr-box { background: #fff; padding: 5px; border-radius: 10px; border: 1px solid #eee; }
        .id-text { font-family: monospace; font-size: 1.1rem; font-weight: 700; word-break: break-all; color: var(--primary-dark); }
        .status-tag { 
            display: inline-block; padding: 4px 10px; border-radius: 12px; 
            background: #eee; font-size: 0.75rem; font-weight: 600; margin-top: 5px; transition: 0.3s;
        }
        .status-tag.connected { background: #D4EDDA; color: #155724; }
        .status-tag.error { background: #F8D7DA; color: #721C24; }

        /* ËøûÊé•ËæìÂÖ• */
        .input-group { 
            display: flex; background: #F5F5F5; border-radius: 12px; padding: 5px; 
            margin-bottom: 12px; border: 2px solid transparent; transition: 0.3s;
        }
        .input-group:focus-within { border-color: var(--primary); background: #FFF; }
        input { 
            flex: 1; border: none; background: transparent; padding: 10px; 
            font-size: 1rem; outline: none; text-align: center; font-weight: 600; color: var(--text);
        }
        .btn-icon { border: none; background: #FFF; width: 40px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; transition: 0.2s; }
        .btn-icon:hover { background: #eee; }
        
        .btn-main { 
            width: 100%; padding: 14px; background: var(--primary); color: white; 
            border: none; border-radius: 12px; font-weight: 700; font-size: 1rem; 
            cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(118, 166, 101, 0.3);
        }
        .btn-main:active { transform: scale(0.98); opacity: 0.9; }

        /* ‰º†ËæìÂå∫ */
        .drop-zone {
            border: 2px dashed #C1D1BE; border-radius: 16px; padding: 30px;
            text-align: center; cursor: pointer; background: #FAFCFA; transition: 0.2s;
        }
        .drop-zone.drag-over { background: #E8F5E9; border-color: var(--primary); transform: scale(1.02); }
        
        .transfer-list { list-style: none; padding: 0; margin: 15px 0 0 0; }
        .transfer-item {
            display: flex; align-items: center; gap: 10px; padding: 12px;
            background: #F9F9F9; border-radius: 12px; margin-bottom: 8px;
            border-left: 5px solid #ddd; animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .transfer-item.sending { border-left-color: #3498DB; }
        .transfer-item.receiving { border-left-color: #F1C40F; }
        .transfer-item.done { border-left-color: var(--primary); background: #fff; border: 1px solid #eee; border-left: 5px solid var(--primary); }
        /* Êñ∞Â¢ûÈîôËØØÁä∂ÊÄÅÊ†∑Âºè */
        .transfer-item.error { border-left-color: var(--error); background: #FFF5F5; }
        .transfer-item.error .t-meta { color: var(--error); }
        
        .t-info { flex: 1; overflow: hidden; }
        .t-name { font-size: 0.9rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .t-meta { font-size: 0.75rem; color: #777; display: flex; justify-content: space-between; margin-top: 4px; }
        .t-bar { height: 6px; background: #eee; margin-top: 6px; border-radius: 3px; overflow: hidden; }
        .t-fill { height: 100%; width: 0%; background: var(--primary); transition: width 0.2s linear; }

        /* ÊÇ¨ÊµÆËÅäÂ§©ÊåâÈíÆ */
        .fab {
            position: fixed; bottom: 30px; right: 30px;
            width: 56px; height: 56px; background: var(--primary); color: white;
            border-radius: 50%; display: none; align-items: center; justify-content: center;
            font-size: 1.5rem; box-shadow: 0 4px 15px rgba(118,166,101,0.4);
            cursor: pointer; z-index: 500; transition: transform 0.2s;
        }
        .fab:active { transform: scale(0.9); }
        .badge {
            position: absolute; top: -2px; right: -2px; width: 16px; height: 16px;
            background: #FF5252; border-radius: 50%; border: 2px solid white; display: none;
        }

        /* ËÅäÂ§©Ê®°ÊÄÅÊ°Ü */
        .chat-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000;
            display: none; align-items: flex-end; justify-content: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .chat-modal.active { display: flex; opacity: 1; }
        
        .chat-box {
            width: 100%; max-width: 500px; height: 85vh;
            background: #F2F4F2; border-radius: 20px 20px 0 0;
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.2); transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .chat-modal.active .chat-box { transform: translateY(0); }
        
        .chat-header {
            padding: 15px; background: #FFF; border-bottom: 1px solid #EEE;
            display: flex; justify-content: space-between; align-items: center;
            font-weight: 700; color: var(--primary);
        }
        
        .chat-msgs {
            flex: 1; padding: 15px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 10px;
        }
        
        .msg {
            max-width: 80%; padding: 10px 14px; border-radius: 16px;
            font-size: 0.95rem; line-height: 1.4; word-break: break-word; position: relative;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .msg.self { align-self: flex-end; background: var(--bubble-self); color: white; border-bottom-right-radius: 2px; }
        .msg.friend { align-self: flex-start; background: var(--bubble-friend); color: #333; border-bottom-left-radius: 2px; }
        .msg.error-msg { background: var(--error); color: white; }
        
        .chat-footer {
            padding: 10px; background: #FFF; border-top: 1px solid #EEE;
            display: flex; gap: 10px; align-items: center;
        }
        .chat-input {
            flex: 1; padding: 10px 15px; background: #F5F5F5; border: none;
            border-radius: 20px; font-size: 1rem; outline: none;
        }

        /* ËæÖÂä©ÁªÑ‰ª∂ */
        #toast { 
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); 
            background: rgba(44, 62, 80, 0.9); color: white; padding: 10px 24px; 
            border-radius: 30px; display: none; z-index: 2000; font-weight: 600;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); text-align: center;
        }
        #scanner-layer { position: fixed; inset: 0; background: #000; z-index: 1500; display: none; }
    </style>
</head>
<body>

    <div class="header">
        <h1><img src="https://cdn-icons-png.flaticon.com/512/3750/3750019.png" width="28"> SlothDrop</h1>
    </div>

    <div class="main-scroll">
        
        <div class="card">
            <span class="card-title">MY IDENTITY</span>
            <div class="id-row">
                <div class="qr-box" id="qrcode"></div>
                <div style="flex:1; overflow:hidden;">
                    <div class="id-text" id="my-id">Generating...</div>
                    <div class="status-tag" id="conn-status">Waiting for network...</div>
                    <button class="btn-icon" style="font-size:0.8rem; width:auto; padding:2px 8px; margin-top:5px; border:1px solid #eee;" onclick="copyId()">Copy ID</button>
                </div>
            </div>
        </div>

        <div class="card" id="card-connect">
            <span class="card-title">CONNECT DEVICE</span>
            <div class="input-group">
                <input type="text" id="target-id" placeholder="Enter Friend's ID (e.g. sloth-xy9z)">
                <button class="btn-icon" onclick="startScan()">üì∑</button>
            </div>
            <button class="btn-main" onclick="connectUser()">Connect</button>
        </div>

        <div class="card" id="card-transfer" style="display:none;">
            <span class="card-title">FILE TRANSFER</span>
            <div class="drop-zone" id="drop-zone">
                <div style="font-size: 2.5rem; margin-bottom:10px;">üìÇ</div>
                <div>Tap or Drag Files Here</div>
            </div>
            <input type="file" id="file-input" multiple style="display:none">
            
            <ul class="transfer-list" id="transfer-list"></ul>
        </div>
    </div>

    <div class="fab" id="fab" onclick="openChat()">
        üí¨
        <div class="badge" id="chat-badge"></div>
    </div>

    <div class="chat-modal" id="chat-modal">
        <div class="chat-box">
            <div class="chat-header">
                <span>üí¨ Secure Chat</span>
                <span onclick="closeChat()" style="padding:10px; cursor:pointer; font-size:1.2rem;">‚úï</span>
            </div>
            <div class="chat-msgs" id="chat-msgs">
                <div style="text-align:center; color:#ccc; margin-top:20px; font-size:0.8rem;">
                    End-to-End Encrypted<br>P2P Connection Established
                </div>
            </div>
            <div class="chat-footer">
                <button class="btn-icon" onclick="document.getElementById('chat-file-input').click()">üìé</button>
                <input type="text" class="chat-input" id="chat-input" placeholder="Message..." autocomplete="off">
                <button class="btn-icon" style="color:var(--primary)" onclick="sendText()">‚û§</button>
            </div>
            <input type="file" id="chat-file-input" multiple style="display:none">
        </div>
    </div>

    <div id="toast">Message</div>
    <div id="scanner-layer">
        <div id="reader" style="width:100%;height:100%"></div>
        <button class="btn-main" style="position:absolute;bottom:50px;left:50%;transform:translateX(-50%);width:auto; z-index:1600;" onclick="stopScan()">Close Camera</button>
    </div>

    <script>
        // --- Core Configuration ---
        const App = {
            peer: null,
            conn: null,
            id: null,
            queue: [],
            isSending: false,
            chunkSize: 16 * 1024, // 16KB Safe chunk
            maxBuffer: 64 * 1024, // 64KB Backpressure limit
            pendingAckResolve: null,
            prefix: 'sloth-'
        };

        const UI = {
            myId: document.getElementById('my-id'),
            status: document.getElementById('conn-status'),
            cardConnect: document.getElementById('card-connect'),
            cardTransfer: document.getElementById('card-transfer'),
            list: document.getElementById('transfer-list'),
            fab: document.getElementById('fab'),
            chatModal: document.getElementById('chat-modal'),
            chatMsgs: document.getElementById('chat-msgs'),
            chatBadge: document.getElementById('chat-badge'),
            dropZone: document.getElementById('drop-zone')
        };

        // --- 1. Initialization & ID Persistence ---
        function init() {
            let storedId = localStorage.getItem('sloth_id');
            if (!storedId) {
                storedId = App.prefix + Math.random().toString(36).substr(2, 5);
                localStorage.setItem('sloth_id', storedId);
            }
            App.id = storedId;
            UI.myId.innerText = App.id;

            new QRCode(document.getElementById("qrcode"), { 
                text: App.id, width: 80, height: 80, 
                colorDark: "#2C3E50", colorLight: "#ffffff", correctLevel: QRCode.CorrectLevel.M 
            });

            App.peer = new Peer(App.id, { debug: 1 });
            
            App.peer.on('open', (id) => {
                UI.status.innerText = "Online - Ready";
                UI.status.className = "status-tag connected";
            });

            App.peer.on('connection', handleConnection);

            App.peer.on('error', (err) => {
                console.error(err);
                if(err.type === 'unavailable-id') {
                    localStorage.removeItem('sloth_id');
                    location.reload();
                } else {
                    UI.status.innerText = "Connection Error";
                    UI.status.className = "status-tag error";
                    showToast("Network Error: " + err.type);
                }
            });

            if ('wakeLock' in navigator) {
                navigator.wakeLock.request('screen').catch(console.error);
            }
        }

        // --- 2. Connection Handling ---
        function connectUser() {
            const id = document.getElementById('target-id').value.trim();
            if(!id) return showToast("Please enter an ID");
            if(id === App.id) return showToast("Cannot connect to self");

            UI.status.innerText = "Connecting...";
            // ‰ΩøÁî® reliable: true Â∞ùËØïÂª∫Á´ãÊõ¥Á®≥ÂÆöÁöÑËøûÊé•
            const conn = App.peer.connect(id, { reliable: true, serialization: 'binary' });
            handleConnection(conn);
        }

        function handleConnection(conn) {
            if (App.conn && App.conn.open) {
                App.conn.close();
            }
            App.conn = conn;

            conn.on('open', () => {
                UI.status.innerText = "Connected to " + conn.peer;
                UI.status.className = "status-tag connected";
                UI.cardConnect.style.display = 'none';
                UI.cardTransfer.style.display = 'block';
                UI.fab.style.display = 'flex';
                showToast("Connected!");
            });

            conn.on('close', () => {
                UI.status.innerText = "Disconnected";
                UI.status.className = "status-tag error";
                showToast("Peer disconnected");
                // ËøûÊé•Êñ≠ÂºÄÊó∂ÔºåÊ∏ÖÁêÜÊú™ÂÆåÊàêÁöÑÈòüÂàó
                App.queue.forEach(job => markTransferError(job.id, "Connection dropped"));
                App.queue = [];
                App.isSending = false;
                setTimeout(() => location.reload(), 2000);
            });

            conn.on('data', onDataReceived);
        }

        // --- 3. Receiving Logic ---
        let rx = { buffer: [], received: 0, meta: null, id: null, start: 0, lastUpdate: 0 };

        function onDataReceived(data) {
            if (data instanceof Uint8Array || data instanceof ArrayBuffer) {
                if (!rx.meta) return;
                rx.buffer.push(data); 
                rx.received += data.byteLength;
                const now = Date.now();
                if (now - rx.lastUpdate > 200 || rx.received === rx.meta.size) {
                    updateProgress(rx.id, rx.received, rx.meta.size, rx.start);
                    rx.lastUpdate = now;
                }
            }
            else if (data.type) {
                switch (data.type) {
                    case 'header':
                        rx = { buffer: [], received: 0, meta: data, id: data.id, start: Date.now(), lastUpdate: 0 };
                        createTransferItem(data.id, data.name, 'receiving', data.mode);
                        // ÂÖ≥ÈîÆÔºöÊî∂Âà∞Â§¥‰ø°ÊÅØÂêéÔºåÂèëÈÄÅ ACK Á°ÆËÆ§
                        App.conn.send({ type: 'ack', id: data.id });
                        break;
                    case 'ack':
                        // ÂèëÈÄÅÁ´ØÊî∂Âà∞ ACKÔºåËß£Èô§Á≠âÂæÖ
                        if (App.pendingAckResolve) {
                            App.pendingAckResolve();
                            App.pendingAckResolve = null;
                        }
                        break;
                    case 'end':
                        const blob = new Blob(rx.buffer, { type: rx.meta.mime });
                        const url = URL.createObjectURL(blob);
                        finishTransferItem(rx.id, url, rx.meta.name, rx.meta.mime, 'in', rx.meta.mode);
                        rx.buffer = []; 
                        break;
                    case 'chat':
                        appendChatMsg(data.text, 'friend');
                        if (!UI.chatModal.classList.contains('active')) {
                            UI.chatBadge.style.display = 'block';
                            showToast("New Message");
                        }
                        break;
                }
            }
        }

        // --- 4. Sending Logic (‰øÆÂ§ç‰∫ÜÂç°‰ΩèÈóÆÈ¢ò) ---
        function enqueueFiles(files, mode) {
            Array.from(files).forEach(f => {
                const id = Date.now() + Math.random().toString(16).slice(2);
                // ÂÖàÂú® UI ‰∏äÊòæÁ§∫‚ÄúÁ≠âÂæÖ‰∏≠‚Äù
                createTransferItem(id, f.name, 'sending', mode);
                App.queue.push({ file: f, id: id, mode: mode });
            });
            processQueue();
        }

        async function processQueue() {
            if (App.isSending || App.queue.length === 0) return;
            
            App.isSending = true;
            const job = App.queue.shift(); // ÂèñÂá∫ÂΩìÂâç‰ªªÂä°

            // ‰øÆÂ§çÁÇπ1ÔºöÂú®Â∞ùËØïÂèëÈÄÅÂâçÊ£ÄÊü•ËøûÊé•„ÄÇÂ¶ÇÊûúÂ§±Ë¥•ÔºåÊ†áËÆ∞ÂΩìÂâç‰ªªÂä°‰∏∫ÈîôËØØ„ÄÇ
            if (!App.conn || !App.conn.open) {
                markTransferError(job.id, "Connection lost before send");
                App.isSending = false;
                processQueue(); // Â∞ùËØï‰∏ã‰∏Ä‰∏™
                return;
            }

            // 1. Send Header
            try {
                App.conn.send({ 
                    type: 'header', name: job.file.name, size: job.file.size, 
                    mime: job.file.type, id: job.id, mode: job.mode 
                });
            } catch (e) {
                markTransferError(job.id, "Failed to send header");
                App.isSending = false;
                processQueue();
                return;
            }

            // 2. Wait for ACK (ËÆæÁΩÆ 8 ÁßíË∂ÖÊó∂)
            try {
                await new Promise((resolve, reject) => {
                    App.pendingAckResolve = resolve;
                    // ‰øÆÂ§çÁÇπ2ÔºöË∂ÖÊó∂ÂêéÊãíÁªù Promise
                    setTimeout(() => reject("ACK Timeout"), 8000); 
                });
            } catch (e) {
                // ‰øÆÂ§çÁÇπ3ÔºöÊçïËé∑Ë∂ÖÊó∂ÔºåÊ†áËÆ∞‰ªªÂä°ÈîôËØØÔºåËÄå‰∏çÊòØÂç°‰Ωè
                showToast("Transfer timed out (No response from receiver)");
                markTransferError(job.id, "Timed out waiting for acceptance");
                App.isSending = false;
                App.pendingAckResolve = null;
                processQueue(); // Â§ÑÁêÜÈòüÂàó‰∏≠ÁöÑ‰∏ã‰∏Ä‰∏™Êñá‰ª∂
                return; 
            }

            // 3. Send Chunks (ÂàáÁâáÂèëÈÄÅ)
            const fileReader = new FileReader();
            let offset = 0;
            const start = Date.now();
            let lastUpdate = 0;

            const readSlice = (o) => new Promise(resolve => {
                const slice = job.file.slice(o, o + App.chunkSize);
                fileReader.onload = e => resolve(e.target.result);
                fileReader.readAsArrayBuffer(slice);
            });

            while (offset < job.file.size) {
                if (!App.conn.open) break; // ‰º†Ëæì‰∏≠ÈÄîÊñ≠ÂºÄÊ£ÄÊü•
                // ËÉåÂéãÊéßÂà∂ÔºöÂ¶ÇÊûúÂØπÊñπÂ§ÑÁêÜ‰∏çËøáÊù•ÔºåÊöÇÂÅúÂèëÈÄÅ
                if (App.conn.dataChannel.bufferedAmount > App.maxBuffer) {
                    await new Promise(r => setTimeout(r, 20));
                    continue;
                }

                const buffer = await readSlice(offset);
                App.conn.send(buffer); 
                offset += buffer.byteLength;

                const now = Date.now();
                if (now - lastUpdate > 200 || offset >= job.file.size) {
                    updateProgress(job.id, offset, job.file.size, start);
                    lastUpdate = now;
                }
            }

            if (App.conn.open) {
                // 4. Send End
                App.conn.send({ type: 'end' });
                finishTransferItem(job.id, null, job.file.name, job.file.type, 'out', job.mode);
            } else {
                markTransferError(job.id, "Connection disconnected during transfer");
            }

            App.isSending = false;
            setTimeout(processQueue, 100); // Next
        }

        // --- 5. UI Rendering ---
        function createTransferItem(id, name, type, mode) {
            if (mode === 'main') {
                const li = document.createElement('li');
                li.className = `transfer-item ${type}`;
                li.id = `item-${id}`;
                li.innerHTML = `
                    <div style="font-size:1.5rem">${type==='sending'?'üì§':'üì•'}</div>
                    <div class="t-info">
                        <div class="t-name">${name}</div>
                        <div class="t-meta"><span class="state">Waiting...</span><span class="speed"></span></div>
                        <div class="t-bar"><div class="t-fill" style="width:0%"></div></div>
                    </div>
                    <div class="actions"></div>
                `;
                UI.list.prepend(li);
            } else {
                const div = document.createElement('div');
                div.className = `msg ${type === 'sending' ? 'self' : 'friend'}`;
                div.id = `bubble-${id}`;
                div.innerHTML = `
                    <div style="min-width:140px">
                        <div style="font-weight:bold; font-size:0.85rem; margin-bottom:5px;">üìÑ ${name}</div>
                        <div class="t-bar" style="background:rgba(0,0,0,0.1);"><div class="t-fill" style="width:0%; background:rgba(255,255,255,0.9);"></div></div>
                        <div class="t-meta" style="font-size:0.7rem; text-align:right; opacity:0.8; margin-top:2px;">Waiting...</div>
                    </div>
                `;
                UI.chatMsgs.appendChild(div);
                UI.chatMsgs.scrollTop = UI.chatMsgs.scrollHeight;
            }
        }

        function updateProgress(id, loaded, total, startTime) {
            const pct = Math.floor((loaded / total) * 100);
            const duration = (Date.now() - startTime) / 1000;
            const speed = duration > 0 ? formatSize(loaded / duration) + '/s' : '';
            
            const elMain = document.getElementById(`item-${id}`);
            if (elMain) {
                elMain.querySelector('.t-fill').style.width = pct + "%";
                elMain.querySelector('.state').innerText = pct + "%";
                elMain.querySelector('.speed').innerText = speed;
            }
            
            const elBubble = document.getElementById(`bubble-${id}`);
            if (elBubble) {
                elBubble.querySelector('.t-fill').style.width = pct + "%";
                elBubble.querySelector('.t-meta').innerText = pct + "%";
            }
        }

        // Êñ∞Â¢ûÔºöÊ†áËÆ∞ÈîôËØØÁä∂ÊÄÅÁöÑÂáΩÊï∞
        function markTransferError(id, errMsg) {
            const elMain = document.getElementById(`item-${id}`);
            if (elMain) {
                elMain.classList.add('error');
                elMain.querySelector('.t-bar').style.display = 'none';
                elMain.querySelector('.t-meta').innerHTML = `<span style="color:var(--error)">‚ùå ${errMsg}</span>`;
            }
            const elBubble = document.getElementById(`bubble-${id}`);
            if (elBubble) {
                elBubble.classList.add('error-msg');
                elBubble.innerHTML = `<div>‚ùå Error: ${errMsg}</div>`;
            }
        }

        function finishTransferItem(id, url, name, mime, dir, mode) {
            const elMain = document.getElementById(`item-${id}`);
            if (elMain) {
                elMain.classList.add('done');
                elMain.querySelector('.t-bar').style.display = 'none';
                elMain.querySelector('.t-meta').innerHTML = `<span style="color:var(--primary)">Completed</span>`;
                if (dir === 'in') {
                    const btn = document.createElement('a');
                    btn.href = url; btn.download = name; 
                    btn.innerHTML = 'üíæ'; btn.style.fontSize = '1.4rem'; btn.style.textDecoration = 'none';
                    elMain.querySelector('.actions').appendChild(btn);
                }
            }
            
            const elBubble = document.getElementById(`bubble-${id}`);
            if (elBubble) {
                if (mime.startsWith('image/')) {
                    elBubble.innerHTML = dir === 'in' 
                        ? `<img src="${url}" style="max-width:200px; border-radius:10px; display:block;">` 
                        : `<div style="opacity:0.8">‚úÖ Image Sent: ${name}</div>`;
                } else {
                    elBubble.innerHTML = dir === 'in' 
                        ? `<a href="${url}" download="${name}" style="color:var(--text); text-decoration:none; display:flex; align-items:center; gap:5px; background:white; padding:8px; border-radius:8px;">üì• Save <b>${name}</b></a>`
                        : `<div style="opacity:0.8">‚úÖ Sent: ${name}</div>`;
                }
                UI.chatMsgs.scrollTop = UI.chatMsgs.scrollHeight;
            }
        }

        // --- 6. Utilities & Events ---
        const formatSize = b => b > 1024*1024 ? (b/1024/1024).toFixed(1)+" MB" : (b/1024).toFixed(0)+" KB";
        const showToast = msg => {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.display = 'block';
            setTimeout(()=>t.style.display='none', 3000);
        };
        const copyId = () => { navigator.clipboard.writeText(App.id); showToast("ID Copied"); };

        UI.dropZone.onclick = () => document.getElementById('file-input').click();
        document.getElementById('file-input').onchange = (e) => enqueueFiles(e.target.files, 'main');
        document.getElementById('chat-file-input').onchange = (e) => enqueueFiles(e.target.files, 'chat');

        function sendText() {
            const input = document.getElementById('chat-input');
            const txt = input.value.trim();
            if(!txt || !App.conn || !App.conn.open) return showToast("Not connected");
            App.conn.send({ type: 'chat', text: txt });
            appendChatMsg(txt, 'self');
            input.value = "";
        }
        
        function appendChatMsg(txt, who) {
            const div = document.createElement('div');
            div.className = `msg ${who}`; div.innerText = txt;
            UI.chatMsgs.appendChild(div);
            UI.chatMsgs.scrollTop = UI.chatMsgs.scrollHeight;
        }

        window.openChat = () => { UI.chatModal.classList.add('active'); UI.chatBadge.style.display='none'; };
        window.closeChat = () => { UI.chatModal.classList.remove('active'); };

        window.addEventListener('dragover', e => e.preventDefault());
        window.addEventListener('drop', e => e.preventDefault());
        UI.dropZone.addEventListener('dragover', () => UI.dropZone.classList.add('drag-over'));
        UI.dropZone.addEventListener('dragleave', () => UI.dropZone.classList.remove('drag-over'));
        UI.dropZone.addEventListener('drop', (e) => {
            UI.dropZone.classList.remove('drag-over');
            if(e.dataTransfer.files.length) enqueueFiles(e.dataTransfer.files, 'main');
        });

        let html5QrCode;
        window.startScan = () => {
            document.getElementById('scanner-layer').style.display = 'block';
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
                (decodedText) => {
                    document.getElementById('target-id').value = decodedText;
                    stopScan();
                    showToast("ID Scanned");
                });
        };
        window.stopScan = () => {
            if(html5QrCode) { html5QrCode.stop().then(() => html5QrCode.clear()); }
            document.getElementById('scanner-layer').style.display = 'none';
        };

        init();
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch(console.error);
        }
    </script>
</body>
</html>
