<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#F7F9F7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>MochiDrop ğŸ¦¥</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3750/3750019.png">
    
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Quicksand:wght@500;600;700&display=swap');
        
        :root {
            --primary: #76A665; --bg: #F7F9F7; --card-bg: #FFF; --text: #2C3E50;
            --bubble-self: #76A665; --bubble-friend: #FFFFFF;
        }

        body { font-family: 'Quicksand', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding-top: 70px; padding-bottom: 40px; -webkit-tap-highlight-color: transparent; }

        /* é€šç”¨ç»„ä»¶ */
        .navbar { position: fixed; top: 0; left: 0; width: 100%; height: 60px; background: rgba(247,249,247,0.95); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; z-index: 1000; box-shadow: 0 1px 0 rgba(0,0,0,0.05); }
        .navbar-title { font-family: 'Fredoka One', cursive; color: var(--primary); font-size: 1.4rem; display: flex; align-items: center; gap: 8px; }
        .card { width: 90%; max-width: 420px; background: var(--card-bg); border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(118,166,101,0.1); margin-bottom: 20px; }
        .card-label { font-size: 0.75rem; color: #95A5A6; font-weight: 700; letter-spacing: 1px; margin-bottom: 15px; display: block; }
        
        /* è¿æ¥ä¸ID */
        .identity-row { display: flex; align-items: center; gap: 15px; }
        .qr-box { width: 90px; height: 90px; background: #F0F2F0; border-radius: 12px; display: flex; align-items: center; justify-content: center; padding: 5px; }
        #qrcode img { width: 100%; display: block; }
        .id-text { font-family: monospace; font-size: 1.1rem; font-weight: 700; word-break: break-all; }
        .status-dot { width: 10px; height: 10px; background: #ccc; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-dot.online { background: var(--primary); box-shadow: 0 0 0 3px rgba(118,166,101,0.2); }
        
        .input-group { display: flex; background: #F0F2F0; border-radius: 12px; padding: 5px; margin-bottom: 10px; }
        input { flex: 1; border: none; background: transparent; padding: 10px; font-size: 1rem; outline: none; text-align: center; font-weight: 600; color: var(--text); }
        .btn-icon { width: 40px; border: none; background: #FFF; border-radius: 8px; cursor: pointer; font-size: 1.2rem; }
        .btn-main { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: 0.2s; }
        .btn-main:active { transform: scale(0.98); opacity: 0.9; }

        /* ä¼ è¾“åˆ—è¡¨ */
        .upload-area { border: 2px dashed #C1D1BE; border-radius: 16px; padding: 30px 20px; text-align: center; cursor: pointer; background: #FAFCFA; transition: 0.3s; }
        .upload-area.hover { background: #E8F5E9; border-color: var(--primary); }
        .file-list { list-style: none; padding: 0; margin: 15px 0 0 0; max-height: 300px; overflow-y: auto; }
        .file-item { background: #FFF; border: 1px solid #EEE; padding: 10px; border-radius: 12px; margin-bottom: 8px; display: flex; align-items: center; gap: 10px; }
        .file-info { flex: 1; overflow: hidden; }
        .file-name { font-size: 0.9rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-meta { font-size: 0.75rem; color: #888; display: flex; justify-content: space-between; margin-top: 3px; }
        .progress-bar { height: 4px; background: #EEE; border-radius: 2px; margin-top: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.2s; }
        .file-action { font-size: 1.2rem; cursor: pointer; padding: 5px; }

        /* èŠå¤©æ‚¬æµ®çƒ */
        #fab-chat { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--primary); border-radius: 50%; color: white; border: none; font-size: 1.5rem; box-shadow: 0 5px 20px rgba(118,166,101,0.4); display: none; align-items: center; justify-content: center; z-index: 2000; cursor: pointer; }
        #fab-badge { position: absolute; top: 0; right: 0; width: 12px; height: 12px; background: red; border-radius: 50%; border: 2px solid white; display: none; }
        
        /* èŠå¤©çª—å£ */
        #chat-modal { position: fixed; bottom: -100%; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; transition: bottom 0.3s; display: flex; align-items: flex-end; justify-content: center; }
        #chat-modal.visible { bottom: 0; }
        .chat-box { width: 100%; max-width: 500px; height: 85vh; background: #F2F4F2; border-radius: 20px 20px 0 0; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 -5px 30px rgba(0,0,0,0.2); }
        .chat-header { padding: 15px; background: #FFF; border-bottom: 1px solid #EEE; display: flex; justify-content: space-between; align-items: center; font-weight: 700; }
        .chat-body { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .chat-footer { padding: 10px; background: #FFF; border-top: 1px solid #EEE; }
        
        /* æ¶ˆæ¯æ°”æ³¡ */
        .msg { max-width: 80%; padding: 10px 14px; border-radius: 16px; font-size: 0.95rem; line-height: 1.4; word-break: break-word; position: relative; }
        .msg.self { align-self: flex-end; background: var(--bubble-self); color: white; border-bottom-right-radius: 2px; }
        .msg.friend { align-self: flex-start; background: var(--bubble-friend); color: #333; border-bottom-left-radius: 2px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .msg-img { max-width: 150px; border-radius: 8px; margin-top: 5px; display: block; cursor: zoom-in; }
        .file-msg { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px; margin-top: 5px; }
        .msg.friend .file-msg { background: #F5F5F5; }
        
        /* è¾“å…¥åŒºåŸŸ */
        .input-row { display: flex; gap: 8px; align-items: center; }
        .chat-input { flex: 1; padding: 10px; background: #F5F5F5; border: none; border-radius: 20px; font-size: 1rem; outline: none; }
        .tool-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: #EEE; cursor: pointer; font-size: 1.2rem; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        
        /* è¾…åŠ©å±‚ */
        #lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 4000; display: none; align-items: center; justify-content: center; }
        #lightbox img { max-width: 95%; max-height: 95%; border-radius: 5px; }
        #toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #333; color: #FFF; padding: 10px 20px; border-radius: 30px; font-size: 0.9rem; z-index: 5000; display: none; }
        #scan-overlay { position: fixed; inset: 0; background: #000; z-index: 4000; display: none; }
        #reader { width: 100%; height: 100%; }
        .close-scan { position: absolute; top: 20px; right: 20px; color: white; background: rgba(0,0,0,0.5); padding: 10px 20px; border-radius: 20px; border: none; font-size: 1rem; z-index: 4001; }
    </style>
</head>
<body onclick="unlockAudio()">

    <audio id="silent-audio" loop>
        <source src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//oeAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAEAAABIADAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMD//////////////////////////////////////////////////////////////////wAAAP//OgAAAAAAAABMYXZjNTguMTM0LjEwMAAAAAAAAAAAAAAA//oeAAAAAAABIAAAAAAAAAAAAAAA//oeAAAAAAAAAAAAAAAAAAAAAAA=" type="audio/mpeg">
    </audio>

    <div class="navbar">
        <div class="navbar-title">
            <img src="https://cdn-icons-png.flaticon.com/512/3750/3750019.png" width="30"> SlothDrop
        </div>
    </div>

    <div class="card" id="identity-panel">
        <span class="card-label">MY IDENTITY</span>
        <div class="identity-row">
            <div class="qr-box" id="qrcode"></div>
            <div>
                <div class="id-text" id="my-id">Connecting...</div>
                <div style="margin-top:5px; font-size:0.85rem; color:#666;">
                    <span class="status-dot" id="status-dot"></span><span id="status-text">Init...</span>
                </div>
            </div>
        </div>
    </div>

    <div class="card" id="connect-panel">
        <span class="card-label">CONNECT</span>
        <div class="input-group">
            <input type="text" id="friend-id" placeholder="Enter Friend ID">
            <button class="btn-icon" onclick="startScan()">ğŸ“·</button>
        </div>
        <button class="btn-main" onclick="connectToFriend()">Connect Now</button>
    </div>

    <div class="card" id="transfer-panel" style="display:none;">
        <span class="card-label">FILE TRANSFER</span>
        <label class="upload-area" id="drop-zone">
            <div style="font-size:2rem; margin-bottom:10px;">ğŸ“‚</div>
            <div>Click or Drag Files Here</div>
        </label>
        <input type="file" id="file-input" multiple style="display:none" onchange="handleFiles(this.files)">
        
        <ul class="file-list" id="main-file-list">
            </ul>
    </div>

    <button id="fab-chat" onclick="toggleChat()">ğŸ’¬<div id="fab-badge"></div></button>

    <div id="chat-modal">
        <div class="chat-box">
            <div class="chat-header">
                <span>ğŸ’¬ Chat</span>
                <span onclick="toggleChat()" style="cursor:pointer; padding:10px;">âœ•</span>
            </div>
            <div class="chat-body" id="chat-body">
                <div style="text-align:center; color:#AAA; font-size:0.8rem; margin-top:20px;">Secure P2P Connection Established</div>
            </div>
            <div class="chat-footer">
                <div class="input-row">
                    <button class="tool-btn" onclick="document.getElementById('chat-file-in').click()">ğŸ“</button>
                    <input type="text" class="chat-input" id="chat-input" placeholder="Message..." autocomplete="off">
                    <button class="tool-btn" style="background:var(--primary); color:white;" onclick="sendText()">â¤</button>
                </div>
                <input type="file" id="chat-file-in" multiple style="display:none" onchange="handleChatFiles(this.files)">
            </div>
        </div>
    </div>

    <div id="toast">Msg</div>
    <div id="lightbox" onclick="this.style.display='none'"><img id="lb-img"></div>
    <div id="scan-overlay">
        <button class="close-scan" onclick="stopScan()">Close Camera</button>
        <div id="reader"></div>
    </div>

    <script>
        // --- æ ¸å¿ƒé…ç½® ---
        const CHUNK_SIZE = 16 * 1024; // 16KB é»„é‡‘ç¨³å®šå€¼
        const MAX_BUFFER = 64 * 1024; // èƒŒå‹é˜ˆå€¼
        
        // --- çŠ¶æ€ç®¡ç† ---
        let peer, conn;
        let myId = null;
        let fileQueue = [];
        let isSending = false;
        
        // DOM ç¼“å­˜
        const ui = {
            idText: document.getElementById('my-id'),
            statusDot: document.getElementById('status-dot'),
            statusText: document.getElementById('status-text'),
            connectPanel: document.getElementById('connect-panel'),
            transferPanel: document.getElementById('transfer-panel'),
            mainList: document.getElementById('main-file-list'),
            chatModal: document.getElementById('chat-modal'),
            chatBody: document.getElementById('chat-body'),
            fab: document.getElementById('fab-chat'),
            badge: document.getElementById('fab-badge'),
            toast: document.getElementById('toast'),
            audio: document.getElementById('silent-audio')
        };

        // --- 1. åˆå§‹åŒ–ä¸è¿æ¥ ---
        function init() {
            peer = new Peer(null, { debug: 1 });
            
            peer.on('open', id => {
                myId = id;
                ui.idText.innerText = id;
                ui.statusDot.classList.add('online');
                ui.statusText.innerText = "Online";
                new QRCode(document.getElementById("qrcode"), { text: id, width: 90, height: 90, colorDark: "#2C3E50", colorLight: "#F0F2F0", correctLevel: QRCode.CorrectLevel.L });
            });

            peer.on('connection', c => {
                conn = c;
                setupConnection();
            });

            peer.on('error', err => showToast("Error: " + err.type));
        }
        init();

        function connectToFriend() {
            const id = document.getElementById('friend-id').value.trim();
            if (!id) return showToast("Enter ID");
            conn = peer.connect(id, { reliable: true });
            setupConnection();
        }

        function setupConnection() {
            conn.on('open', () => {
                showToast("Connected!");
                ui.connectPanel.style.display = 'none'; // å¼ºåˆ¶éšè—è¿æ¥é¢æ¿
                ui.transferPanel.style.display = 'block'; // å¼ºåˆ¶æ˜¾ç¤ºä¼ è¾“é¢æ¿
                ui.fab.style.display = 'flex';
                ui.statusText.innerText = "Linked";
            });
            
            conn.on('close', () => {
                showToast("Disconnected");
                setTimeout(() => location.reload(), 1000);
            });

            conn.on('data', handleData);
        }

        // --- 2. ç»Ÿä¸€æ•°æ®å¤„ç†æ ¸å¿ƒ ---
        // æ¥æ”¶çŠ¶æ€æœº
        let rxState = { buffer: [], received: 0, meta: null, id: null, start: 0, lastUpdate: 0 };

        function handleData(data) {
            // A. äºŒè¿›åˆ¶æ•°æ®æµ (æ–‡ä»¶å†…å®¹)
            if (data instanceof ArrayBuffer || data instanceof Uint8Array) {
                if (!rxState.meta) return;
                
                const chunk = new Uint8Array(data);
                rxState.buffer.push(chunk);
                rxState.received += chunk.byteLength;

                // èŠ‚æµæ›´æ–° UI
                const now = Date.now();
                if (now - rxState.lastUpdate > 200 || rxState.received === rxState.meta.size) {
                    const speed = calculateSpeed(rxState.received, rxState.start);
                    const pct = Math.floor((rxState.received / rxState.meta.size) * 100);
                    updateProgressUI(rxState.id, pct, speed, true); // true = receiver
                    rxState.lastUpdate = now;
                }
            }
            // B. JSON æ§åˆ¶ä¿¡ä»¤
            else if (data.type) {
                if (data.type === 'header') {
                    // å¼€å§‹æ¥æ”¶
                    rxState.buffer = []; rxState.received = 0; rxState.meta = data;
                    rxState.id = data.id; rxState.start = Date.now(); rxState.lastUpdate = 0;
                    
                    if (data.isChat) {
                        addChatFileBubble(data.id, data.name, 'friend');
                        notify("Receiving File...");
                    } else {
                        addMainListItem(data.id, data.name, 'down');
                    }
                }
                else if (data.type === 'end') {
                    // æ¥æ”¶å®Œæˆ -> ç»„è£…æ–‡ä»¶
                    const blob = new Blob(rxState.buffer, { type: rxState.meta.mime });
                    const url = URL.createObjectURL(blob);
                    
                    if (rxState.meta.isChat) {
                        finishChatFile(rxState.id, url, rxState.meta.name, rxState.meta.mime, false);
                        notify("File Received!");
                    } else {
                        finishMainFile(rxState.id, url, rxState.meta.name);
                        showToast("Download Ready");
                    }
                    rxState.buffer = []; // é‡Šæ”¾å†…å­˜
                }
                else if (data.type === 'chat') {
                    addChatMessage(data.text, 'friend');
                    notify("New Message");
                }
            }
        }

        // --- 3. ç»Ÿä¸€å‘é€æ ¸å¿ƒ (Phoenix Engine) ---
        async function processSendQueue() {
            if (isSending || fileQueue.length === 0) return;
            isSending = true;

            const job = fileQueue.shift(); // å–å‡ºä»»åŠ¡
            const file = job.file;
            const id = job.id;
            const isChat = job.isChat;

            // 1. å‘é€å¤´
            conn.send({ type: 'header', name: file.name, size: file.size, mime: file.type, isChat: isChat, id: id });

            // 2. å‘é€ä½“ (åˆ‡ç‰‡)
            let offset = 0;
            const start = Date.now();
            let lastUpdate = 0;

            while (offset < file.size) {
                // èƒŒå‹æ§åˆ¶ï¼šå¦‚æœç¼“å†²åŒºæ»¡äº†ï¼Œæš‚åœä¸€ä¸‹
                if (conn.dataChannel.bufferedAmount > MAX_BUFFER) {
                    await new Promise(r => setTimeout(r, 10));
                    continue;
                }

                const chunk = file.slice(offset, offset + CHUNK_SIZE);
                const buffer = await chunk.arrayBuffer();
                conn.send(buffer); // ç›´æ¥å‘é€ ArrayBufferï¼Œæ•ˆç‡æœ€é«˜
                offset += CHUNK_SIZE;

                // æ›´æ–°å‘é€ç«¯ UI
                const now = Date.now();
                if (now - lastUpdate > 200 || offset >= file.size) {
                    const speed = calculateSpeed(offset, start);
                    const pct = Math.min(100, Math.floor((offset / file.size) * 100));
                    updateProgressUI(id, pct, speed, false);
                    lastUpdate = now;
                }
            }

            // 3. å‘é€å°¾
            conn.send({ type: 'end' });

            // 4. å‘é€ç«¯å–„å (é¢„è§ˆ/å®Œæˆæ€)
            if (isChat) {
                // å‘é€æ–¹ç›´æ¥ç”¨æœ¬åœ°æ–‡ä»¶åšé¢„è§ˆï¼Œä¸éœ€è¦ç­‰å›ä¼ 
                const url = URL.createObjectURL(file);
                finishChatFile(id, url, file.name, file.type, true);
            } else {
                finishMainFile(id, null, file.name); // ä¸»ç•Œé¢åªéœ€è¦æ˜¾ç¤ºå®Œæˆ
            }

            isSending = false;
            processSendQueue(); // ç»§ç»­ä¸‹ä¸€ä¸ª
        }

        function calculateSpeed(bytes, startTime) {
            const time = (Date.now() - startTime) / 1000;
            if (time <= 0) return "0 KB/s";
            const bps = bytes / time;
            return bps > 1048576 ? (bps/1048576).toFixed(1) + " MB/s" : (bps/1024).toFixed(0) + " KB/s";
        }

        // --- 4. ç•Œé¢äº¤äº’é€»è¾‘ ---
        
        // ä¸»åˆ—è¡¨æ“ä½œ
        function handleFiles(files) {
            for (let file of files) {
                const id = Date.now() + Math.random().toString(16).slice(2);
                addMainListItem(id, file.name, 'up');
                fileQueue.push({ file: file, id: id, isChat: false });
            }
            processSendQueue();
        }

        function addMainListItem(id, name, type) {
            const li = document.createElement('li');
            li.className = 'file-item';
            li.id = `item-${id}`;
            const icon = type === 'up' ? 'ğŸ“¤' : 'ğŸ“¥';
            li.innerHTML = `
                <div style="font-size:1.5rem;">${icon}</div>
                <div class="file-info">
                    <div class="file-name">${name}</div>
                    <div class="file-meta">
                        <span class="status-text">Waiting...</span>
                        <span class="speed-text"></span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" style="width:0%"></div></div>
                </div>
                <div class="file-action"></div>
            `;
            ui.mainList.prepend(li);
        }

        function updateProgressUI(id, pct, speed, isReceiver) {
            const el = isReceiver && !document.getElementById(`item-${id}`) 
                ? document.getElementById(`bubble-${id}`) // èŠå¤©æ°”æ³¡
                : document.getElementById(`item-${id}`);  // ä¸»åˆ—è¡¨é¡¹
            
            if (!el) return;

            // é€‚é…ä¸åŒ DOM ç»“æ„
            const bar = el.querySelector('.progress-fill') || el.querySelector('.chat-progress-fill');
            const txt = el.querySelector('.status-text') || el.querySelector('.file-meta'); // èŠå¤©æ°”æ³¡ç”¨ file-meta
            
            if (bar) bar.style.width = pct + "%";
            if (txt) txt.innerText = `${pct}% â€¢ ${speed}`;
        }

        function finishMainFile(id, url, name) {
            const el = document.getElementById(`item-${id}`);
            if (!el) return;
            el.querySelector('.progress-bar').style.display = 'none';
            el.querySelector('.status-text').innerText = "Complete";
            el.querySelector('.status-text').style.color = "var(--primary)";
            
            if (url) {
                // æ¥æ”¶æ–¹æ˜¾ç¤ºä¿å­˜æŒ‰é’®
                el.querySelector('.file-action').innerHTML = `<a href="${url}" download="${name}" style="text-decoration:none">ğŸ’¾</a>`;
            } else {
                // å‘é€æ–¹
                el.querySelector('.file-action').innerHTML = "âœ…";
            }
        }

        // èŠå¤©æ“ä½œ
        function handleChatFiles(files) {
            for (let file of files) {
                const id = Date.now() + Math.random().toString(16).slice(2);
                addChatFileBubble(id, file.name, 'self');
                fileQueue.push({ file: file, id: id, isChat: true });
            }
            processSendQueue();
        }

        function sendText() {
            const text = document.getElementById('chat-input').value.trim();
            if (!text || !conn) return;
            conn.send({ type: 'chat', text: text });
            addChatMessage(text, 'self');
            document.getElementById('chat-input').value = "";
        }

        function addChatMessage(text, type) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerText = text;
            ui.chatBody.appendChild(div);
            scrollToBottom();
        }

        function addChatFileBubble(id, name, type) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.id = `bubble-${id}`;
            div.innerHTML = `
                <div class="file-msg">
                    <span style="font-size:1.5rem">ğŸ“„</span>
                    <div style="flex:1; overflow:hidden;">
                        <div class="file-name">${name}</div>
                        <div class="progress-bar"><div class="progress-fill chat-progress-fill" style="width:0%"></div></div>
                        <div class="file-meta" style="font-size:0.7rem; text-align:right;">Waiting...</div>
                    </div>
                </div>
            `;
            ui.chatBody.appendChild(div);
            scrollToBottom();
        }

        function finishChatFile(id, url, name, mime, isSender) {
            const el = document.getElementById(`bubble-${id}`);
            if (!el) return;
            
            if (mime.startsWith('image/')) {
                el.innerHTML = `<img src="${url}" class="msg-img" onclick="openLightbox('${url}')">`;
            } else {
                if (isSender) {
                    el.innerHTML = `<div class="file-msg"><span>âœ…</span> ${name}</div>`;
                } else {
                    el.innerHTML = `<div class="file-msg" onclick="saveFile('${url}', '${name}')" style="cursor:pointer; background:#fff; color:#333;">
                        <span>ğŸ“¥</span> <span style="text-decoration:underline">Tap to Save: ${name}</span>
                    </div>`;
                }
            }
            scrollToBottom();
        }

        // --- è¾…åŠ©åŠŸèƒ½ ---
        function toggleChat() {
            const modal = ui.chatModal;
            const isOpen = modal.classList.contains('visible');
            if (isOpen) {
                modal.classList.remove('visible');
            } else {
                modal.classList.add('visible');
                ui.badge.style.display = 'none';
            }
        }

        function notify(msg) {
            if (!ui.chatModal.classList.contains('visible')) {
                ui.badge.style.display = 'block';
                showToast(msg);
                playDing();
            }
        }

        function playDing() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const o = ctx.createOscillator(); const g = ctx.createGain();
                o.connect(g); g.connect(ctx.destination);
                o.frequency.value = 1000; g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.5);
                o.start(); o.stop(ctx.currentTime + 0.5);
            } catch(e) {}
            if(navigator.vibrate) navigator.vibrate(100);
        }

        function unlockAudio() { ui.audio.play().catch(()=>{}); document.body.onclick = null; }
        
        function scrollToBottom() { ui.chatBody.scrollTop = ui.chatBody.scrollHeight; }
        window.saveFile = (url, name) => { const a = document.createElement('a'); a.href = url; a.download = name; a.click(); };
        window.openLightbox = (src) => { document.getElementById('lb-img').src = src; document.getElementById('lightbox').style.display = 'flex'; };
        
        // æ‹–æ‹½æ”¯æŒ
        const dz = document.getElementById('drop-zone');
        dz.ondragover = e => { e.preventDefault(); dz.classList.add('hover'); };
        dz.ondragleave = e => { e.preventDefault(); dz.classList.remove('hover'); };
        dz.ondrop = e => { e.preventDefault(); dz.classList.remove('hover'); handleFiles(e.dataTransfer.files); };

        function showToast(msg) {
            ui.toast.innerText = msg; ui.toast.style.display = 'block';
            setTimeout(() => ui.toast.style.display = 'none', 3000);
        }

        // æ‰«ç 
        function startScan() { document.getElementById('scan-overlay').style.display = 'flex'; html5QrCode = new Html5Qrcode("reader"); html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, t => { document.getElementById('friend-id').value = t; stopScan(); showToast("Scanned"); }, null); }
        function stopScan() { html5QrCode?.stop(); document.getElementById('scan-overlay').style.display = 'none'; }
        
        // å›è½¦å‘é€
        document.getElementById('chat-input').addEventListener('keydown', e => { if(e.key==='Enter') sendText(); });
    </script>
</body>
</html>
