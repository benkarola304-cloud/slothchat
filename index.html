<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#E9F5DB">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>MochiDrop Reborn ü¶•</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3750/3750019.png">
    
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Quicksand:wght@500;600;700&display=swap');
        
        :root {
            /* Ê†ëÊáí‰∏ªÈ¢òËâ≤ */
            --primary: #76A665;
            --primary-light: #B5D6B2;
            --bg: #F2F7F2;
            --card: #FFFFFF;
            --text: #2C3E50;
            --grey: #95A5A6;
            --bubble-self: #76A665;
            --bubble-friend: #FFFFFF;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Quicksand', sans-serif; background: var(--bg); color: var(--text);
            margin: 0; display: flex; flex-direction: column; align-items: center; 
            height: 100vh; overflow: hidden; /* Èò≤Ê≠¢Êï¥‰ΩìÊªöÂä® */
        }

        /* --- È°∂ÈÉ®ÂØºËà™ --- */
        .header {
            width: 100%; height: 60px; background: rgba(255,255,255,0.9);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 1px 5px rgba(0,0,0,0.05); z-index: 100;
            flex-shrink: 0;
        }
        .header h1 { 
            font-family: 'Fredoka One', cursive; color: var(--primary); font-size: 1.4rem; 
            margin: 0; display: flex; align-items: center; gap: 10px;
        }

        /* --- ‰∏ªÊªöÂä®Âå∫Âüü --- */
        .main-scroll {
            flex: 1; width: 100%; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; align-items: center; gap: 20px;
        }

        /* --- Âç°ÁâáÊ†∑Âºè --- */
        .card {
            width: 100%; max-width: 450px; background: var(--card);
            border-radius: 20px; padding: 20px;
            box-shadow: 0 5px 15px rgba(118, 166, 101, 0.1);
        }
        .card-title {
            font-size: 0.8rem; color: var(--grey); font-weight: 700; 
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px;
        }

        /* ID & ËøûÊé• */
        .id-row { display: flex; align-items: center; gap: 15px; }
        .qr-box { background: #F0F0F0; padding: 5px; border-radius: 10px; }
        .id-text { font-family: monospace; font-size: 1.2rem; font-weight: 700; word-break: break-all;}
        .status-tag { 
            display: inline-block; padding: 4px 10px; border-radius: 12px; 
            background: #eee; font-size: 0.75rem; font-weight: 600; margin-top: 5px;
        }
        .status-tag.connected { background: #D4EDDA; color: #155724; }

        .input-group { 
            display: flex; background: #F5F5F5; border-radius: 12px; padding: 5px; 
            margin-bottom: 10px; border: 1px solid transparent; transition: 0.3s;
        }
        .input-group:focus-within { border-color: var(--primary); background: #FFF; }
        input { 
            flex: 1; border: none; background: transparent; padding: 10px; 
            font-size: 1rem; outline: none; text-align: center; font-weight: 600; color: var(--text);
        }
        .btn-icon { border: none; background: #FFF; width: 40px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; }
        .btn-main { 
            width: 100%; padding: 14px; background: var(--primary); color: white; 
            border: none; border-radius: 12px; font-weight: 700; font-size: 1rem; 
            cursor: pointer; transition: 0.2s; 
        }
        .btn-main:active { transform: scale(0.98); opacity: 0.9; }

        /* ‰º†ËæìÂå∫Âüü */
        .drop-zone {
            border: 2px dashed #C1D1BE; border-radius: 16px; padding: 30px;
            text-align: center; cursor: pointer; background: #FAFCFA; transition: 0.2s;
        }
        .drop-zone.drag-over { background: #E8F5E9; border-color: var(--primary); transform: scale(1.02); }
        
        .transfer-list { list-style: none; padding: 0; margin: 15px 0 0 0; }
        .transfer-item {
            display: flex; align-items: center; gap: 10px; padding: 10px;
            background: #F9F9F9; border-radius: 10px; margin-bottom: 8px;
            border-left: 4px solid #ddd;
        }
        .transfer-item.sending { border-left-color: #3498DB; }
        .transfer-item.receiving { border-left-color: #F1C40F; }
        .transfer-item.done { border-left-color: var(--primary); }
        .transfer-item.error { border-left-color: #E74C3C; }
        
        .t-info { flex: 1; overflow: hidden; }
        .t-name { font-size: 0.9rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .t-meta { font-size: 0.75rem; color: #777; display: flex; justify-content: space-between; margin-top: 3px; }
        .t-bar { height: 4px; background: #eee; margin-top: 5px; border-radius: 2px; overflow: hidden; }
        .t-fill { height: 100%; width: 0%; background: var(--primary); transition: width 0.2s; }

        /* ËÅäÂ§©ÊÇ¨ÊµÆÁêÉ */
        .fab {
            position: fixed; bottom: 30px; right: 30px;
            width: 60px; height: 60px; background: var(--primary); color: white;
            border-radius: 50%; display: none; align-items: center; justify-content: center;
            font-size: 1.8rem; box-shadow: 0 5px 20px rgba(118,166,101,0.4);
            cursor: pointer; z-index: 500; transition: transform 0.2s;
        }
        .fab:active { transform: scale(0.9); }
        .badge {
            position: absolute; top: 0; right: 0; width: 14px; height: 14px;
            background: #FF5252; border-radius: 50%; border: 2px solid white; display: none;
        }

        /* ËÅäÂ§©Á™óÂè£ */
        .chat-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000;
            display: none; align-items: flex-end; justify-content: center;
        }
        .chat-modal.active { display: flex; }
        
        .chat-box {
            width: 100%; max-width: 500px; height: 85vh;
            background: #F2F4F2; border-radius: 20px 20px 0 0;
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.2);
        }
        
        .chat-header {
            padding: 15px; background: #FFF; border-bottom: 1px solid #EEE;
            display: flex; justify-content: space-between; align-items: center;
            font-weight: 700; color: var(--primary);
        }
        
        .chat-msgs {
            flex: 1; padding: 15px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 10px;
        }
        
        .msg {
            max-width: 80%; padding: 10px 14px; border-radius: 16px;
            font-size: 0.95rem; line-height: 1.4; word-break: break-word;
            position: relative;
        }
        .msg.self { align-self: flex-end; background: var(--bubble-self); color: white; border-bottom-right-radius: 2px; }
        .msg.friend { align-self: flex-start; background: var(--bubble-friend); color: #333; border-bottom-left-radius: 2px; }
        
        .chat-img { max-width: 200px; border-radius: 8px; cursor: zoom-in; display: block; margin-top: 5px; }
        
        .chat-input-area {
            padding: 10px; background: #FFF; border-top: 1px solid #EEE;
            display: flex; gap: 10px; align-items: center;
        }
        .chat-input {
            flex: 1; padding: 10px 15px; background: #F5F5F5; border: none;
            border-radius: 20px; font-size: 1rem; outline: none;
        }
        
        /* ËæÖÂä©ÂÖÉÁ¥† */
        #toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 30px; display: none; z-index: 2000; }
        #scanner-layer { position: fixed; inset: 0; background: #000; z-index: 1500; display: none; }
        #lightbox { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; display: none; justify-content: center; align-items: center; }
        #lightbox img { max-width: 95%; max-height: 95%; border-radius: 5px; }
        
        /* Ë°®ÊÉÖÈù¢Êùø */
        .emoji-panel {
            display: none; padding: 10px; background: #FFF;
            grid-template-columns: repeat(8, 1fr); gap: 5px;
            border-top: 1px solid #EEE; max-height: 150px; overflow-y: auto;
        }
        .emoji { cursor: pointer; font-size: 1.4rem; text-align: center; padding: 5px; }
        
    </style>
</head>
<body>

    <div class="header">
        <h1><img src="https://cdn-icons-png.flaticon.com/512/3750/3750019.png" width="30"> SlothDrop</h1>
    </div>

    <div class="main-scroll">
        
        <div class="card">
            <span class="card-title">MY IDENTITY</span>
            <div class="id-row">
                <div class="qr-box" id="qrcode"></div>
                <div>
                    <div class="id-text" id="my-id">Initializing...</div>
                    <div class="status-tag" id="conn-status">Waiting for network...</div>
                </div>
            </div>
        </div>

        <div class="card" id="card-connect">
            <span class="card-title">CONNECT DEVICE</span>
            <div class="input-group">
                <input type="text" id="target-id" placeholder="Enter Friend's ID">
                <button class="btn-icon" onclick="startScan()">üì∑</button>
            </div>
            <button class="btn-main" onclick="connectUser()">Connect</button>
        </div>

        <div class="card" id="card-transfer" style="display:none;">
            <span class="card-title">FILE TRANSFER</span>
            <div class="drop-zone" id="drop-zone">
                <div style="font-size: 2rem;">üìÇ</div>
                <div>Click or Drag Files/Folders Here</div>
            </div>
            <input type="file" id="file-input" multiple style="display:none">
            
            <ul class="transfer-list" id="transfer-list">
                </ul>
        </div>
    </div>

    <div class="fab" id="fab" onclick="openChat()">
        üí¨
        <div class="badge" id="chat-badge"></div>
    </div>

    <div class="chat-modal" id="chat-modal">
        <div class="chat-box">
            <div class="chat-header">
                <span>üí¨ Chat</span>
                <span onclick="closeChat()" style="padding:10px; cursor:pointer;">‚úï</span>
            </div>
            <div class="chat-msgs" id="chat-msgs">
                <div style="text-align:center; color:#ccc; margin-top:20px; font-size:0.8rem;">Secure Connection Established</div>
            </div>
            <div class="emoji-panel" id="emoji-panel"></div>
            <div class="chat-footer">
                <button class="btn-icon" onclick="document.getElementById('chat-file-input').click()">üìé</button>
                <button class="btn-icon" onclick="toggleEmoji()">üòä</button>
                <input type="text" class="chat-input" id="chat-input" placeholder="Message..." autocomplete="off">
                <button class="btn-icon" style="color:var(--primary)" onclick="sendText()">‚û§</button>
            </div>
            <input type="file" id="chat-file-input" multiple style="display:none">
        </div>
    </div>

    <div id="toast">Message</div>
    <div id="scanner-layer"><div id="reader" style="width:100%;height:100%"></div><button class="btn-main" style="position:absolute;bottom:50px;left:50%;transform:translateX(-50%);width:auto" onclick="stopScan()">Close Camera</button></div>
    <div id="lightbox" onclick="this.style.display='none'"><img id="lb-img"></div>

    <script>
        // --- ÂÖ®Â±ÄÁä∂ÊÄÅ ---
        const App = {
            peer: null,
            conn: null,
            id: null,
            queue: [], // ÂèëÈÄÅÈòüÂàó
            isSending: false, // ÂèëÈÄÅÈîÅ
            chunkSize: 16 * 1024, // 16KB ÂÆâÂÖ®ÂàáÁâá
            maxBuffer: 64 * 1024 // 64KB ËÉåÂéãÈòàÂÄº
        };

        const UI = {
            myId: document.getElementById('my-id'),
            status: document.getElementById('conn-status'),
            cardConnect: document.getElementById('card-connect'),
            cardTransfer: document.getElementById('card-transfer'),
            list: document.getElementById('transfer-list'),
            fab: document.getElementById('fab'),
            chatModal: document.getElementById('chat-modal'),
            chatMsgs: document.getElementById('chat-msgs'),
            chatBadge: document.getElementById('chat-badge'),
            dropZone: document.getElementById('drop-zone')
        };

        // --- 1. ÂàùÂßãÂåñ PeerJS ---
        function init() {
            App.peer = new Peer(null, { debug: 1 });
            
            App.peer.on('open', id => {
                App.id = id;
                UI.myId.innerText = id;
                UI.status.innerText = "Online - Ready to Connect";
                new QRCode(document.getElementById("qrcode"), { text: id, width: 90, height: 90, colorDark: "#2C3E50", colorLight: "#F0F0F0", correctLevel: QRCode.CorrectLevel.L });
            });

            App.peer.on('connection', conn => {
                handleConnection(conn);
            });

            App.peer.on('error', err => showToast("Error: " + err.type));
        }
        init(); // ÂêØÂä®

        // --- 2. ËøûÊé•Â§ÑÁêÜ ---
        function connectUser() {
            const id = document.getElementById('target-id').value.trim();
            if(!id) return showToast("Please enter ID");
            const conn = App.peer.connect(id, { reliable: true });
            handleConnection(conn);
        }

        function handleConnection(conn) {
            App.conn = conn;
            
            conn.on('open', () => {
                showToast("Connected!");
                UI.status.innerText = "Connected";
                UI.status.classList.add('connected');
                
                // ÂàáÊç¢ÁïåÈù¢
                UI.cardConnect.style.display = 'none';
                UI.cardTransfer.style.display = 'block';
                UI.fab.style.display = 'flex';
            });

            conn.on('close', () => {
                showToast("Disconnected");
                setTimeout(() => location.reload(), 1500);
            });

            conn.on('data', data => onDataReceived(data));
        }

        // --- 3. Ê†∏ÂøÉÊé•Êî∂ÈÄªËæë (Áä∂ÊÄÅÊú∫) ---
        let rxState = { buffer: [], received: 0, meta: null, id: null, start: 0, lastUpdate: 0 };

        function onDataReceived(data) {
            // A. ‰∫åËøõÂà∂Êï∞ÊçÆ (Êñá‰ª∂Âùó)
            if (data instanceof Uint8Array || data instanceof ArrayBuffer) {
                if (!rxState.meta) return; // ËøòÊ≤°ÊúâÊî∂Âà∞Â§¥Ôºå‰∏¢ÂºÉ
                
                const chunk = new Uint8Array(data);
                rxState.buffer.push(chunk);
                rxState.received += chunk.byteLength;

                // ËäÇÊµÅÊõ¥Êñ∞ËøõÂ∫¶
                const now = Date.now();
                if (now - rxState.lastUpdate > 200 || rxState.received === rxState.meta.size) {
                    updateProgress(rxState.id, rxState.received, rxState.meta.size, rxState.start);
                    rxState.lastUpdate = now;
                }
            }
            // B. ÊéßÂà∂‰ø°‰ª§ (JSON)
            else if (data.type) {
                if (data.type === 'header') {
                    // 1. ÂáÜÂ§áÊé•Êî∂
                    rxState.buffer = []; rxState.received = 0; rxState.meta = data; 
                    rxState.id = data.id; rxState.start = Date.now();
                    
                    // 2. ÂàõÂª∫ UI
                    createTransferItem(data.id, data.name, 'receiving', data.mode);
                    
                    // 3. ÂÖ≥ÈîÆÔºöÂèëÈÄÅ ACK Á°ÆËÆ§ÔºåÂëäËØâÂèëÈÄÅÊñπÂèØ‰ª•ÂèëÊï∞ÊçÆ‰∫Ü
                    App.conn.send({ type: 'ack', id: data.id });
                }
                else if (data.type === 'ack') {
                    // ÂèëÈÄÅÊñπÊî∂Âà∞ ACKÔºåËß¶ÂèëÈòüÂàóÁªßÁª≠
                    if (App.pendingAckResolve) {
                        App.pendingAckResolve();
                        App.pendingAckResolve = null;
                    }
                }
                else if (data.type === 'end') {
                    // 4. Êé•Êî∂ÂÆåÊàêÔºåÁîüÊàêÊñá‰ª∂
                    const blob = new Blob(rxState.buffer, { type: rxState.meta.mime });
                    const url = URL.createObjectURL(blob);
                    finishTransferItem(rxState.id, url, rxState.meta.name, rxState.meta.mime, 'in', rxState.meta.mode);
                    rxState.buffer = []; rxState.meta = null;
                }
                else if (data.type === 'chat') {
                    appendChatMsg(data.text, 'friend');
                    if (UI.chatModal.style.display !== 'flex') {
                        UI.chatBadge.style.display = 'block';
                        showToast("New Message");
                    }
                }
            }
        }

        // --- 4. Ê†∏ÂøÉÂèëÈÄÅÈÄªËæë (ÈòüÂàó + ACKÊè°Êâã) ---
        // Ê∑ªÂä†Êñá‰ª∂Âà∞ÈòüÂàó
        function enqueueFiles(files, mode) {
            for (let f of files) {
                const id = Date.now() + Math.random().toString(16).slice(2);
                // Á´ãÂç≥ÂàõÂª∫ UI
                createTransferItem(id, f.name, 'sending', mode);
                // ÂÖ•Èòü
                App.queue.push({ file: f, id: id, mode: mode });
            }
            processQueue();
        }

        async function processQueue() {
            if (App.isSending || App.queue.length === 0) return;
            App.isSending = true;

            const job = App.queue.shift();
            
            // 1. ÂèëÈÄÅ Header
            App.conn.send({ 
                type: 'header', 
                name: job.file.name, 
                size: job.file.size, 
                mime: job.file.type, 
                id: job.id, 
                mode: job.mode 
            });

            // 2. Á≠âÂæÖ ACK (Èò≤Ê≠¢Êé•Êî∂ÊñπÊ≤°ÂáÜÂ§áÂ•Ω)
            try {
                await new Promise((resolve, reject) => {
                    App.pendingAckResolve = resolve;
                    setTimeout(() => reject("Timeout"), 5000); // 5ÁßíË∂ÖÊó∂
                });
            } catch (e) {
                showToast("Connection unstable, skipping file.");
                App.isSending = false;
                processQueue();
                return;
            }

            // 3. ÂèëÈÄÅÊï∞ÊçÆÂùó
            let offset = 0;
            const start = Date.now();
            let lastUpdate = 0;

            while (offset < job.file.size) {
                // ËÉåÂéãÊéßÂà∂ÔºöÂ¶ÇÊûúÁºìÂÜ≤Âå∫Êª°‰∫ÜÔºåÊöÇÂÅú
                if (App.conn.dataChannel.bufferedAmount > App.maxBuffer) {
                    await new Promise(r => setTimeout(r, 20));
                    continue;
                }

                const chunk = job.file.slice(offset, offset + App.chunkSize);
                const buffer = await chunk.arrayBuffer();
                App.conn.send(new Uint8Array(buffer));
                offset += App.chunkSize;

                // Êõ¥Êñ∞ UI
                const now = Date.now();
                if (now - lastUpdate > 200 || offset >= job.file.size) {
                    updateProgress(job.id, offset, job.file.size, start);
                    lastUpdate = now;
                }
            }

            // 4. ÂèëÈÄÅÁªìÊùü
            App.conn.send({ type: 'end' });
            
            // ÂèëÈÄÅÊñπÊú¨Âú∞ÂÆåÊàêÁä∂ÊÄÅ
            const url = URL.createObjectURL(job.file);
            finishTransferItem(job.id, url, job.file.name, job.file.type, 'out', job.mode);

            App.isSending = false;
            processQueue(); // ‰∏ã‰∏Ä‰∏™
        }

        // --- 5. PC ÊãñÊãΩÊñá‰ª∂Â§πÊ∑±Â∫¶Êâ´Êèè ---
        // ËøôÊòØ‰∏Ä‰∏™ÈÄíÂΩíÂáΩÊï∞ÔºåÁî®Êù•‚ÄúÊåñ‚ÄùÂá∫Êñá‰ª∂Â§πÈáåÊâÄÊúâÁöÑÊñá‰ª∂
        async function scanFiles(entry) {
            if (entry.isFile) {
                return new Promise(resolve => entry.file(f => resolve([f])));
            } else if (entry.isDirectory) {
                const reader = entry.createReader();
                const entries = await new Promise(resolve => reader.readEntries(resolve));
                let files = [];
                for (let e of entries) files = files.concat(await scanFiles(e));
                return files;
            }
            return [];
        }

        async function handleDrop(e, mode) {
            e.preventDefault();
            UI.dropZone.classList.remove('drag-over');
            
            const items = e.dataTransfer.items;
            let files = [];
            
            for (let i = 0; i < items.length; i++) {
                const entry = items[i].webkitGetAsEntry ? items[i].webkitGetAsEntry() : null;
                if (entry) {
                    files = files.concat(await scanFiles(entry));
                } else if (items[i].kind === 'file') {
                    files.push(items[i].getAsFile());
                }
            }
            
            if (files.length > 0) enqueueFiles(files, mode);
        }

        // --- 6. UI Ê∏≤Êüì‰∏éÊõ¥Êñ∞ ---
        
        function createTransferItem(id, name, type, mode) {
            // mode: 'main' (‰∏ªÂàóË°®) or 'chat' (ËÅäÂ§©Ê∞îÊ≥°)
            // type: 'sending' or 'receiving'
            
            if (mode === 'main') {
                const li = document.createElement('li');
                li.className = `transfer-item ${type}`;
                li.id = `item-${id}`;
                li.innerHTML = `
                    <div style="font-size:1.5rem">${type==='sending'?'üì§':'üì•'}</div>
                    <div class="t-info">
                        <div class="t-name">${name}</div>
                        <div class="t-meta"><span class="state">Waiting...</span><span class="speed"></span></div>
                        <div class="t-bar"><div class="t-fill" style="width:0%"></div></div>
                    </div>
                    <div class="actions"></div>
                `;
                UI.list.prepend(li);
            } else {
                const div = document.createElement('div');
                div.className = `msg ${type === 'sending' ? 'self' : 'friend'}`;
                div.id = `bubble-${id}`;
                div.innerHTML = `
                    <div style="min-width:150px">
                        <div style="font-weight:bold; font-size:0.9rem">üìÑ ${name}</div>
                        <div class="t-bar" style="background:rgba(0,0,0,0.1); margin-top:5px;"><div class="t-fill" style="width:0%; background:rgba(255,255,255,0.8);"></div></div>
                        <div class="t-meta" style="font-size:0.7rem; text-align:right; opacity:0.8">Waiting...</div>
                    </div>
                `;
                UI.chatMsgs.appendChild(div);
                UI.chatMsgs.scrollTop = UI.chatMsgs.scrollHeight;
            }
        }

        function updateProgress(id, loaded, total, startTime) {
            const pct = Math.floor((loaded / total) * 100);
            const duration = (Date.now() - startTime) / 1000;
            const speed = duration > 0 ? formatSize(loaded / duration) + '/s' : '';
            
            // Êõ¥Êñ∞‰∏ªÂàóË°®
            const mainItem = document.getElementById(`item-${id}`);
            if (mainItem) {
                mainItem.querySelector('.t-fill').style.width = pct + "%";
                mainItem.querySelector('.state').innerText = pct + "%";
                mainItem.querySelector('.speed').innerText = speed;
            }
            
            // Êõ¥Êñ∞ËÅäÂ§©Ê∞îÊ≥°
            const bubble = document.getElementById(`bubble-${id}`);
            if (bubble) {
                bubble.querySelector('.t-fill').style.width = pct + "%";
                bubble.querySelector('.t-meta').innerText = pct + "% " + speed;
            }
        }

        function finishTransferItem(id, url, name, mime, dir, mode) {
            const isImg = mime.startsWith('image/');
            
            // Êõ¥Êñ∞‰∏ªÂàóË°®
            const mainItem = document.getElementById(`item-${id}`);
            if (mainItem) {
                mainItem.classList.add('done');
                mainItem.querySelector('.t-bar').style.display = 'none';
                mainItem.querySelector('.t-meta').innerHTML = `<span style="color:var(--primary)">Completed</span>`;
                
                if (dir === 'in') {
                    // Êé•Êî∂ÊñπÔºöÊòæÁ§∫‰∏ãËΩΩÊåâÈíÆ
                    const btn = document.createElement('a');
                    btn.href = url; btn.download = name; 
                    btn.innerHTML = 'üì•'; btn.style.fontSize = '1.5rem'; btn.style.textDecoration = 'none';
                    mainItem.querySelector('.actions').appendChild(btn);
                } else {
                    // ÂèëÈÄÅÊñπ
                    mainItem.querySelector('.actions').innerText = "‚úÖ";
                }
            }
            
            // Êõ¥Êñ∞ËÅäÂ§©Ê∞îÊ≥°
            const bubble = document.getElementById(`bubble-${id}`);
            if (bubble) {
                if (isImg) {
                    bubble.innerHTML = `<img src="${url}" style="max-width:200px; border-radius:10px; cursor:zoom-in;" onclick="openLightbox('${url}')">`;
                } else {
                    if (dir === 'in') {
                        bubble.innerHTML = `<div style="background:#FFF; color:#333; padding:10px; border-radius:10px; cursor:pointer;" onclick="downloadFile('${url}', '${name}')">üì• Tap to Save: ${name}</div>`;
                    } else {
                        bubble.innerHTML = `<div style="opacity:0.8">‚úÖ Sent: ${name}</div>`;
                    }
                }
                UI.chatMsgs.scrollTop = UI.chatMsgs.scrollHeight;
            }
        }

        // --- 7. ËæÖÂä©ÂäüËÉΩ ---
        function formatSize(b) {
            return b > 1024*1024 ? (b/1024/1024).toFixed(1)+" MB" : (b/1024).toFixed(0)+" KB";
        }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.display = 'block';
            setTimeout(()=>t.style.display='none', 3000);
        }
        window.openLightbox = (src) => { 
            document.getElementById('lb-img').src = src; 
            document.getElementById('lightbox').style.display = 'flex'; 
        };
        window.downloadFile = (url, name) => {
            const a = document.createElement('a'); a.href = url; a.download = name; a.click();
        }

        // --- 8. ‰∫ã‰ª∂ÁªëÂÆö ---
        
        // ÊãñÊãΩ
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
            document.body.addEventListener(e, ev => ev.preventDefault()); // ÂÖ®Â±ÄÁ¶ÅÊ≠¢ÈªòËÆ§ÊâìÂºÄ
        });
        
        // ‰∏ªÁïåÈù¢ÊãñÊãΩ
        UI.dropZone.ondragover = () => UI.dropZone.classList.add('drag-over');
        UI.dropZone.ondragleave = () => UI.dropZone.classList.remove('drag-over');
        UI.dropZone.ondrop = (e) => {
            UI.dropZone.classList.remove('drag-over');
            handleDrop(e, 'main');
        };
        
        // ÁÇπÂáªÈÄâÊã©Êñá‰ª∂
        UI.dropZone.onclick = () => document.getElementById('file-input').click();
        document.getElementById('file-input').onchange = (e) => enqueueFiles(e.target.files, 'main');
        
        // ËÅäÂ§©Êñá‰ª∂ÈÄâÊã©
        document.getElementById('chat-file-input').onchange = (e) => enqueueFiles(e.target.files, 'chat');

        // ËÅäÂ§©Ê∂àÊÅØ
        function sendText() {
            const input = document.getElementById('chat-input');
            const txt = input.value.trim();
            if(!txt || !App.conn) return;
            App.conn.send({ type: 'chat', text: txt });
            appendChatMsg(txt, 'self');
            input.value = "";
            document.getElementById('emoji-panel').style.display = 'none';
        }
        function appendChatMsg(txt, who) {
            const div = document.createElement('div');
            div.className = `msg ${who}`; div.innerText = txt;
            UI.chatMsgs.appendChild(div);
            UI.chatMsgs.scrollTop = UI.chatMsgs.scrollHeight;
        }
        
        // Ë°®ÊÉÖ
        const emojis = ["üòÄ","üòÇ","üòç","üò≠","üëç","üôè","üéâ","‚ù§Ô∏è","ü§î","üòé","üëã","üî•"];
        const ep = document.getElementById('emoji-panel');
        emojis.forEach(e => {
            let s = document.createElement('div'); s.className = 'emoji'; s.innerText = e;
            s.onclick = () => { document.getElementById('chat-input').value += e; };
            ep.appendChild(s);
        });
        function toggleEmoji() { ep.style.display = ep.style.display==='grid'?'none':'grid'; }

        // ËÅäÂ§©Á™óÂè£ÂºÄÂÖ≥
        function openChat() { UI.chatModal.classList.add('active'); UI.chatBadge.style.display='none'; }
        function closeChat() { UI.chatModal.classList.remove('active'); }

        // Êâ´Á†Å
        let html5QrCode;
        function startScan() {
            document.getElementById('scanner-layer').style.display = 'block';
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
                (decodedText) => {
                    document.getElementById('target-id').value = decodedText;
                    stopScan();
                    showToast("ID Scanned");
                });
        }
        function stopScan() {
            if(html5QrCode) html5QrCode.stop();
            document.getElementById('scanner-layer').style.display = 'none';
        }

    </script>
</body>
</html>
